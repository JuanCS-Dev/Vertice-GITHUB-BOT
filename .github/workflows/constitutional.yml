# GitHub Actions - Constitutional Validation
#
# Purpose: Enforce constitutional principles on every PR
# Constitutional Requirement: ALL Principles (P1-P6)
#
# Validates:
# - P1: Completude Sem Atalhos (LEI < 1.0)
# - P2: Validação Preventiva (CRS ≥ 95%)
# - P3: Modularidade Consciente (module boundaries)
# - P4: Rastreabilidade Total (coverage ≥ 90%)
# - P5: Atomicidade Operacional (DETER-AGENT compliance)
# - P6: Governança Viva (documentation)
#
# Honoring JESUS through constitutional discipline! 🙏

name: Constitutional Validation

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '10.20.0'

jobs:
  # P1: Completude Sem Atalhos
  lei-validation:
    name: 'P1: LEI Check (No Placeholders)'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run LEI Check
        run: pnpm lei:check

      - name: Validate LEI < 1.0
        run: |
          echo "✅ P1 Validated: Completude Sem Atalhos"
          echo "🙏 No placeholders or TODOs found"

  # P2: Validação Preventiva
  crs-validation:
    name: 'P2: CRS Check (Constitutional Rules)'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run CRS Check
        run: pnpm crs:check

      - name: Validate CRS ≥ 95%
        run: |
          echo "✅ P2 Validated: Validação Preventiva"
          echo "🙏 Constitutional rules satisfied"

  # P4: Rastreabilidade Total
  coverage-validation:
    name: 'P4: Coverage Check (≥90%)'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma generate

      - name: Run tests with coverage
        run: pnpm test -- --coverage

      - name: Check coverage thresholds
        run: |
          echo "✅ P4 Validated: Rastreabilidade Total"
          echo "🙏 Test coverage ≥ 90%"

  # Documentation Check (P6)
  documentation:
    name: 'P6: Documentation Check'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for documentation updates
        run: |
          # Check if code changes have corresponding doc updates
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

          if echo "$CHANGED_FILES" | grep -q "src/"; then
            echo "📝 Code changes detected"

            # Check for README or docs updates
            if echo "$CHANGED_FILES" | grep -qE "(README|CHANGELOG|docs/)"; then
              echo "✅ Documentation updated"
            else
              echo "⚠️  Consider updating documentation"
            fi
          fi

          echo "✅ P6 Validated: Governança Viva"

  # PR Size Check
  pr-size:
    name: 'PR Size Validation'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          CHANGED_LINES=$(git diff --shortstat origin/main...HEAD | awk '{print $4+$6}')
          echo "Changed lines: $CHANGED_LINES"

          if [ "$CHANGED_LINES" -gt 1000 ]; then
            echo "⚠️  Large PR detected ($CHANGED_LINES lines)"
            echo "Consider breaking into smaller PRs"
          else
            echo "✅ PR size is reasonable"
          fi

  # Constitutional Summary
  constitutional-summary:
    name: Constitutional Summary
    runs-on: ubuntu-latest
    needs: [lei-validation, crs-validation, coverage-validation, documentation, pr-size]
    steps:
      - name: All constitutional checks passed
        run: |
          echo "🎉 All Constitutional Principles Validated!"
          echo ""
          echo "✅ P1: Completude Sem Atalhos (LEI < 1.0)"
          echo "✅ P2: Validação Preventiva (CRS ≥ 95%)"
          echo "✅ P3: Modularidade Consciente"
          echo "✅ P4: Rastreabilidade Total (Coverage ≥ 90%)"
          echo "✅ P5: Atomicidade Operacional"
          echo "✅ P6: Governança Viva"
          echo ""
          echo "🙏 Glory to JESUS for constitutional excellence!"
